{% extends "base.html" %}

{% block title %}Login - Smart Attendance{% endblock %}

{% block main_class %}{% endblock %}

{% block content %}
<div class="gradient-bg min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8 bg-white rounded-2xl shadow-2xl p-8 md:p-12">
        <!-- Logo/Header -->
        <div class="text-center">
            <i class="fas fa-camera text-5xl text-purple-600 mb-4"></i>
            <h2 class="text-3xl font-bold text-gray-900">Smart Attendance</h2>
            <p class="mt-2 text-gray-600">Sign in to your account</p>
        </div>
        
        <!-- Tabs -->
        <div class="flex border-b border-gray-200">
            <button id="loginTab" class="flex-1 py-3 text-center font-semibold border-b-2 border-purple-600 text-purple-600 transition" onclick="showTab('login')">
                Login
            </button>
            <button id="registerTab" class="flex-1 py-3 text-center font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition" onclick="showTab('register')">
                Register
            </button>
        </div>
        
        <!-- Login Form -->
        <div id="loginForm" class="space-y-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="your@email.com" required>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="••••••••" required>
            </div>
            
            <button onclick="handleLogin()" class="w-full btn-primary text-white font-semibold py-3 rounded-lg">
                <i class="fas fa-sign-in-alt mr-2"></i> Sign In
            </button>
        </div>
        
        <!-- Registration Form -->
        <div id="registerForm" class="space-y-6 hidden">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                <input type="text" id="registerName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="John Doe" required>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="registerEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="your@email.com" required>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                <input type="tel" id="registerPhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="+1234567890">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                <input type="text" id="registerDepartment" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="Engineering">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input type="password" id="registerPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent" placeholder="••••••••" required>
            </div>
            
            <!-- Camera Section -->
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-camera mr-2"></i>Capture Face Photos (Minimum 3)
                </label>
                
                <div id="cameraContainer" class="hidden mb-4">
                    <video id="registerVideo" class="w-full rounded-lg mb-2" autoplay playsinline></video>
                    <button onclick="captureImage()" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700">
                        <i class="fas fa-camera mr-2"></i>Capture Photo
                    </button>
                </div>
                
                <button id="startCameraBtn" onclick="startCamera()" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg hover:bg-blue-700 mb-2">
                    <i class="fas fa-video mr-2"></i>Start Camera
                </button>
                
                <canvas id="captureCanvas" class="hidden"></canvas>
                
                <div id="capturedImages" class="grid grid-cols-3 gap-2 mt-4"></div>
                
                <p class="text-sm text-gray-500 mt-2">
                    Photos captured: <span id="photoCount" class="font-bold">0</span>/3
                </p>
            </div>
            
            <button onclick="handleRegister()" class="w-full btn-primary text-white font-semibold py-3 rounded-lg">
                <i class="fas fa-user-plus mr-2"></i> Register
            </button>
        </div>
        
        <div class="text-center text-sm text-gray-600">
            <a href="/" class="text-purple-600 hover:text-purple-700">
                <i class="fas fa-arrow-left mr-1"></i>Back to Home
            </a>
        </div>
    </div>
</div>

<script>
    let capturedImages = [];
    let stream = null;
    
    // Check URL params for tab
    window.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const tab = urlParams.get('tab');
        if (tab === 'register') {
            showTab('register');
        }
    });
    
    function showTab(tab) {
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        
        if (tab === 'login') {
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            loginTab.classList.add('border-purple-600', 'text-purple-600');
            loginTab.classList.remove('border-transparent', 'text-gray-500');
            registerTab.classList.add('border-transparent', 'text-gray-500');
            registerTab.classList.remove('border-purple-600', 'text-purple-600');
        } else {
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            registerTab.classList.add('border-purple-600', 'text-purple-600');
            registerTab.classList.remove('border-transparent', 'text-gray-500');
            loginTab.classList.add('border-transparent', 'text-gray-500');
            loginTab.classList.remove('border-purple-600', 'text-purple-600');
        }
    }
    
    async function handleLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        if (!email || !password) {
            showToast('Please fill in all fields', 'error');
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                localStorage.setItem('access_token', data.access_token);
                localStorage.setItem('user', JSON.stringify(data.user));
                
                showToast('Login successful!', 'success');
                
                // Redirect based on role
                setTimeout(() => {
                    if (data.user.role === 'super_admin') {
                        window.location.href = '/super-admin';
                    } else if (data.user.role === 'admin') {
                        window.location.href = '/admin';
                    } else {
                        window.location.href = '/dashboard';
                    }
                }, 1000);
            } else {
                showToast(data.error || 'Login failed', 'error');
            }
        } catch (error) {
            showToast('An error occurred. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }
    
    async function startCamera() {
        try {
            const constraints = {
                video: {
                    width: { ideal: 1280 },
                    height: { ideal: 720 },
                    facingMode: 'user'
                }
            };
            
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            const video = document.getElementById('registerVideo');
            video.srcObject = stream;
            
            document.getElementById('cameraContainer').classList.remove('hidden');
            document.getElementById('startCameraBtn').classList.add('hidden');
            
            showToast('Camera started successfully', 'success');
        } catch (error) {
            console.error('Camera error:', error);
            showToast('Failed to access camera. Please check permissions.', 'error');
        }
    }
    
    function captureImage() {
        if (capturedImages.length >= 3) {
            showToast('Maximum 3 photos allowed', 'warning');
            return;
        }
        
        const video = document.getElementById('registerVideo');
        const canvas = document.getElementById('captureCanvas');
        const context = canvas.getContext('2d');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        context.drawImage(video, 0, 0);
        
        const imageData = canvas.toDataURL('image/jpeg', 0.8);
        capturedImages.push(imageData);
        
        displayCapturedImages();
        document.getElementById('photoCount').textContent = capturedImages.length;
        
        showToast(`Photo ${capturedImages.length} captured!`, 'success');
    }
    
    function displayCapturedImages() {
        const container = document.getElementById('capturedImages');
        container.innerHTML = '';
        
        capturedImages.forEach((img, index) => {
            const div = document.createElement('div');
            div.className = 'relative';
            div.innerHTML = `
                <img src="${img}" class="w-full h-24 object-cover rounded-lg">
                <button onclick="removeImage(${index})" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600">
                    <i class="fas fa-times text-xs"></i>
                </button>
            `;
            container.appendChild(div);
        });
    }
    
    function removeImage(index) {
        capturedImages.splice(index, 1);
        displayCapturedImages();
        document.getElementById('photoCount').textContent = capturedImages.length;
    }
    
    async function handleRegister() {
        const name = document.getElementById('registerName').value;
        const email = document.getElementById('registerEmail').value;
        const phone = document.getElementById('registerPhone').value;
        const department = document.getElementById('registerDepartment').value;
        const password = document.getElementById('registerPassword').value;
        
        if (!name || !email || !password) {
            showToast('Please fill in all required fields', 'error');
            return;
        }
        
        if (capturedImages.length < 3) {
            showToast('Please capture at least 3 face photos', 'error');
            return;
        }
        
        showLoading();
        
        try {
            const response = await fetch('/api/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name,
                    email,
                    phone,
                    department,
                    password,
                    images: capturedImages
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                showToast('Registration successful! Please wait for admin approval.', 'success');
                
                // Stop camera
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                setTimeout(() => {
                    showTab('login');
                }, 2000);
            } else {
                showToast(data.error || 'Registration failed', 'error');
            }
        } catch (error) {
            showToast('An error occurred. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }
</script>
{% endblock %}
